<!doctype html>
<meta charset="utf-8">
<title>Peli</title>
<style>
	canvas {
		width: 640px;
		height: 360px;

		border: 1px solid;
	}
</style>

<body>

	<canvas>
	</canvas>

	<script>
		let log = console.log

		const WIDTH = 21
		const HEIGHT = 10

		const TILE_WIDTH = 14
		const TILE_HEIGHT = 14

		let tiles = [
			0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
			0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0,
			0, 1, 0, 1, 0, 1, 0, 1, 0, 2, 0, 2, 0, 1, 0, 1, 0, 1, 0, 1, 0,
			0, 2, 1, 2, 1, 2, 1, 2, 0, 0, 0, 0, 0, 2, 1, 2, 1, 2, 1, 2, 0,
			0, 1, 0, 1, 0, 1, 0, 1, 0, 2, 0, 2, 0, 1, 0, 1, 0, 1, 0, 1, 0,

			0, 1, 1, 1, 1, 1, 1, 1, 0, 2, 0, 2, 0, 1, 1, 1, 1, 1, 1, 1, 0,
			0, 1, 0, 1, 0, 1, 0, 1, 0, 2, 0, 2, 0, 1, 0, 1, 0, 1, 0, 1, 0,
			0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0,
			0, 1, 0, 1, 0, 1, 0, 1, 0, 2, 0, 2, 0, 1, 0, 1, 0, 1, 0, 1, 0,
			0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0,
		]

		// Player is on which kind of tile?
		function currentTile() {
			return tiles[Math.floor(playerX) + WIDTH * Math.floor(playerY)]
		}
		
		let c = document.querySelector('canvas')

		let ctx = c.getContext('2d')

		function tile(x, y) {
			// log('tile', x, y)
			let xStart = x * TILE_WIDTH
			let yStart = y * TILE_HEIGHT

			let content = tiles[WIDTH * y + x]
			if (content === 0) {
				ctx.fillStyle = '#f4b27d'
			} else if (content === 1) {
				ctx.fillStyle = '#98c23d'
			} else if (content === 2) {
				ctx.fillStyle = '#ff9061'
			}

			ctx.fillRect(xStart, yStart, TILE_WIDTH, TILE_HEIGHT)
		}

		function drawLevel() {
			for (let x = 0; x < WIDTH; x++) {
				for (let y = 0; y < HEIGHT; y++) {
					tile(x, y)
				}
			}
		}

		// Middle point of player
		let playerX = 0.5 * (0 + WIDTH)
		let playerY = 0.5

		function drawPlayer() {
			ctx.fillStyle = '#000000'
			ctx.fillRect(playerX * TILE_WIDTH, playerY * TILE_HEIGHT, 1, 1)
		}

		function drawPlayerPositionDebug() {
			let playerPositionText = `${playerX.toFixed(2)}, ${playerY.toFixed(2)}`
			ctx.textAlign = 'center'
			ctx.font = '7px sans-serif'
			ctx.fillText(playerPositionText, playerX * TILE_WIDTH, playerY * TILE_WIDTH - 3)
		}

		function drawPlayerTileDebug() {
			let tile = currentTile()
			ctx.textAlign = 'center'
			ctx.font = '7px sans-serif'
			ctx.fillText(tile, playerX * TILE_WIDTH, playerY * TILE_WIDTH + 10)
		}

		let keys = {
			up: 0,
			down: 0,
			left: 0,
			right: 0,
		}

		function keydown(event) {

			log('keydown', event.key, event.char, event.keyCode)

			// don't prevent alt-r (hack!)
			let keyCode = event.keyCode
			if (keyCode === 82) {
				return;
			}
			event.preventDefault()

			if (event.repeat) {
				return
			}

			if (keyCode === 38) {
				keys.up = 1
			} else if (keyCode === 40) {
				keys.down = 1
			} else if (keyCode === 37) {
				keys.left = 1
			} else if (keyCode === 39) {
				keys.right = 1
			}

			// log('down', keyCode, keys)
		}

		function keyup(event) {
			let keyCode = event.keyCode
			event.preventDefault()

			if (event.repeat) {
				return
			}

			if (keyCode === 38) {
				keys.up = 0
			} else if (keyCode === 40) {
				keys.down = 0
			} else if (keyCode === 37) {
				keys.left = 0
			} else if (keyCode === 39) {
				keys.right = 0
			}

			// log('up', keyCode, keys)
		}

		window.addEventListener('keydown', keydown)
		window.addEventListener('keyup', keyup)

		const SPEED = 0.05

		function frame() {

			let oldPlayerX
			let oldPlayerY

			function savePlayerPosition() {
				oldPlayerX = playerX
				oldPlayerY = playerY
			} 

			function movePlayerX() {
				if (keys.right) {
					playerX += SPEED
				}
				if (keys.left) {
					playerX -= SPEED
				}
			}

			function movePlayerY() {
				if (keys.up) {
					playerY -= SPEED
				}
				if (keys.down) {
					playerY += SPEED
				}
			}

			function isPlayerBlocked() {
				if (currentTile() === 2) {
					return true
				}
				return false
			}

			function restorePositionIfBlocked() {
				let isBlocked = isPlayerBlocked()
				if (isBlocked) {
					playerX = oldPlayerX
					playerY = oldPlayerY
				}
			}

			savePlayerPosition()
			movePlayerX()
			movePlayerY()
			restorePositionIfBlocked()
			
			drawLevel()
			drawPlayer()
			drawPlayerPositionDebug()
			drawPlayerTileDebug()

			// log('player', playerX, playerY)
		}

		setInterval(frame, 1000 / 60)
	</script>

</body>
